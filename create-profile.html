<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Save Profile - Mmories.org</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
</head>
<body>
  <section class="container" style="margin-top: 50px; width: 50%;">
    <h1 class="text-primary">Save Profile</h1>
    <div class="card">
      <div class="card-body">
        <h2>About mmories</h2>
        <p>Immortalize your MMO characters forever. Upload a screenshot, enter their name and guild, and create a cosmic legacy.</p>
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-body">
        <p>Hello, traveler.</p>
        <p>I’m Corshark — a fellow adventurer, and the creator of mmories.com.</p>
        <p>We live in an age where MMORPGs are vanishing — fading into silence as their servers go dark.</p>
        <p>The worlds we once explored, the names we chose, the guilds we called home... they deserve more than deletion.</p>
        <p>That’s why I created mmories.com:</p>
        <p>a space where your characters can live on, even after the games are gone.</p>
        <p>This is that place.</p>
        <p>Here, your legacy won’t vanish. It will be immortalized.</p>
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-body">
        <h2>Immortalize Your Character</h2>
        <form id="profileForm">
          <div class="form-group">
            <label for="characterName">Character Name <span class="text-info">ℹ️</span></label>
            <input type="text" class="form-control" id="characterName" placeholder="Enter character name">
          </div>
          <div class="form-group">
            <label for="guildName">Guild <span class="text-info">ℹ️</span></label>
            <input type="text" class="form-control" id="guildName" placeholder="Enter guild name">
          </div>
          <div class="form-group">
            <label for="mmoGame">MMO Game <span class="text-info">ℹ️</span></label>
            <input type="text" class="form-control" id="mmoGame" placeholder="Enter MMO game">
          </div>
          <div class="form-group">
            <label for="screenshot1">Character Screenshot 1 <span class="text-info">ℹ️</span></label>
            <input type="file" class="form-control" id="screenshot1" accept="image/*">
          </div>
          <div id="extraScreenshots"></div>
          <button type="button" class="btn btn-secondary mt-2" id="addScreenshot">Add Another Screenshot</button>
          <button type="submit" class="btn btn-primary mt-2">Immortalize</button>
        </form>
        <div class="mt-3">
          <p>Advertisement</p>
        </div>
      </div>
    </div>
  </section>

  <script type="module">
    // Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBbQkQ2Sy9pMyKx68z3p_PLwTON70BS1PQ",
      authDomain: "mmories-org-live.firebaseapp.com",
      projectId: "mmories-org-live",
      storageBucket: "mmories-org-live.firebasestorage.app",
      messagingSenderId: "978660559442",
      appId: "1:978660559442:web:b874b822f391a765a4ed8b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);

    // Handle adding extra screenshot fields
    let screenshotCount = 1;
    document.getElementById('addScreenshot').addEventListener('click', () => {
      screenshotCount++;
      const extraScreenshotsDiv = document.getElementById('extraScreenshots');
      const newInput = document.createElement('div');
      newInput.className = 'form-group';
      newInput.innerHTML = `
        <label for="screenshot${screenshotCount}">Character Screenshot ${screenshotCount} <span class="text-info">ℹ️</span></label>
        <input type="file" class="form-control" id="screenshot${screenshotCount}" accept="image/*">
      `;
      extraScreenshotsDiv.appendChild(newInput);
    });

    // Handle form submission
    document.getElementById('profileForm').addEventListener('submit', async (event) => {
      event.preventDefault();

      const characterName = document.getElementById('characterName').value.trim();
      const guildName = document.getElementById('guildName').value.trim();
      const mmoGame = document.getElementById('mmoGame').value.trim();
      const screenshots = Array.from({ length: screenshotCount }, (_, i) => 
        document.getElementById(`screenshot${i + 1}`)?.files[0]
      ).filter(file => file); // Only include selected files

      // Validate guild name
      if (guildName.toLowerCase() === 'roofer') {
        alert('Error: The guild name "Roofer" is reserved for founders only.');
        return;
      }

      // Validate required fields
      if (!characterName || !guildName || !mmoGame || screenshots.length === 0) {
        alert('Error: All fields are required, including at least one screenshot.');
        return;
      }

      try {
        // Create a new profile reference
        const profilesRef = ref(database, 'profiles');
        const newProfileRef = push(profilesRef);

        // Upload screenshots to Firebase Storage
        const screenshotURLs = await Promise.all(
          screenshots.map(async (file, index) => {
            const screenshotRef = storageRef(storage, `screenshots/${newProfileRef.key}/screenshot${index + 1}_${file.name}`);
            await uploadBytes(screenshotRef, file);
            return getDownloadURL(screenshotRef);
          })
        );

        // Save profile data to Realtime Database
        await set(newProfileRef, {
          characterName,
          guildName,
          mmoGame,
          screenshotURLs,
          timestamp: Date.now()
        });

        alert('Profile immortalized successfully!');
        window.location.href = `profile.html?profile=${newProfileRef.key}`;
        document.getElementById('profileForm').reset();
        document.getElementById('extraScreenshots').innerHTML = ''; // Clear extra screenshot fields
        screenshotCount = 1; // Reset screenshot count
      } catch (error) {
        console.error('Error saving profile:', error);
        alert('Error immortalizing profile. Please try again.');
      }
    });
  </script>
</body>
</html>